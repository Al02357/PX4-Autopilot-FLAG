#!/bin/sh
# PX4 commands need the 'px4-' prefix in bash.
# (px4-alias.sh is expected to be in the PATH)
. px4-alias.sh

uorb start
muorb start

# Sleep a little here. A lot happens when the uorb and muorb start
# and we need to make sure that it all completes successfully to avoid
# any possible race conditions.
sleep 1

param load

sleep 1

param set SYS_AUTOSTART 4001
param set SYS_AUTOCONFIG 0

param set EKF2_ABL_LIM 0.8
param set EKF2_TAU_POS 0.25
param set EKF2_TAU_VEL 0.25

param set MPC_VELD_LP 5.0

param set MC_AIRMODE 0

# tweak MPC_THR_MIN to prevent roll/pitch losing control
# authority under rapid downward acceleration
param set MPC_THR_MAX 0.75
param set MPC_THR_MIN 0.08
param set MPC_MANTHR_MIN 0.05

# default position mode with a little expo, smooth mode is terrible
param set MPC_POS_MODE 0
param set MPC_YAW_EXPO 0.20
param set MPC_XY_MAN_EXPO 0.20
param set MPC_Z_MAN_EXPO 0.20

# max velocities
param set MPC_VEL_MANUAL 5.0
param set MPC_XY_VEL_MAX 5.0
param set MPC_XY_CRUISE 5.0
param set MPC_Z_VEL_MAX_DN 1.5
param set MPC_Z_VEL_MAX_UP 4.0
param set MPC_LAND_SPEED 1.0

# Horizontal position PID
param set MPC_XY_P 0.95
param set MPC_XY_VEL_P_ACC 3.00
param set MPC_XY_VEL_I_ACC 0.10
param set MPC_XY_VEL_D_ACC 0.00

# Vertical position PID
# PX4 Defaults
param set MPC_Z_P 1.0
param set MPC_Z_VEL_P_ACC 8.0
param set MPC_Z_VEL_I_ACC 2.0
param set MPC_Z_VEL_D_ACC 0.0

param set MPC_TKO_RAMP_T 1.50
param set MPC_TKO_SPEED	1.50
param set MPC_SPOOLUP_TIME 0.0

# disable rotation check on landing
param set LNDMC_ROT_MAX 500.0

param set ATT_W_MAG 0.00

param set BAT_N_CELLS 3
param set BAT1_V_CHARGED 4.05

param set MAV_TYPE 2

param set MC_YAW_P 2.0
param set MC_YAWRATE_P 0.15
param set MC_YAWRATE_I 0.1
param set MC_YAWRATE_D 0.0
param set MC_YAWRATE_K 1.0

param set MC_PITCH_P 5.5
param set MC_PITCHRATE_P 0.08
param set MC_PITCHRATE_I 0.2
param set MC_PITCHRATE_D 0.0013
param set MC_PITCHRATE_K 1.0

param set MC_ROLL_P 5.5
param set MC_ROLLRATE_P 0.08
param set MC_ROLLRATE_I 0.2
param set MC_ROLLRATE_D 0.0013
param set MC_ROLLRATE_K 1.0

param set COM_RC_IN_MODE 1

# Sending joystick commands over wifi is a bad idea for manual mode flight.
# Best to only do this in position hold mode. Set a big timeout for this.
param set COM_RC_LOSS_T 2.0

param set RTL_LAND_DELAY 1.0
param set RTL_DESCEND_ALT 10
param set RTL_RETURN_ALT 50

# Disable action on data link lost
param set NAV_DLL_ACT 0

# ESC configuration for M500
param set UART_ESC_CONFIG 1
param set UART_ESC_MOTOR1 1
param set UART_ESC_MOTOR2 4
param set UART_ESC_MOTOR3 2
param set UART_ESC_MOTOR4 3
param set UART_ESC_RPM_MAX 8000
param set UART_ESC_RPM_MIN 1000

# Allow arming without battery
param set CBRK_SUPPLY_CHK 894281

# Disable auto disarm. This is number of seconds to wait for takeoff
# after arming. If no takeoff happens then it will disarm. A negative
# value disables this.
param set COM_DISARM_PRFLT -1

sleep 1

# Start logging on start and use timestamps for log files
logger start -e -t

dataman start

navigator start

commander start
commander mode manual

param set MAV_BROADCAST 1
mavlink start -x -u 14556 -r 40000
sleep 1
mavlink stream -u 14556 -s HIGHRES_IMU -r 5
mavlink stream -u 14556 -s ATTITUDE -r 5
# mavlink stream -u 14556 -s RC_CHANNELS -r 20

# Pixhawk 4 GPS module
gps start -d /dev/ttyHS1 -b 38400

sleep 1

# sensors start
qshell sensors start

# ekf2 start
qshell ekf2 start

# mc_pos_control start
qshell mc_pos_control start

# mc_att_control start
qshell mc_att_control start

# mc_rate_control start
qshell mc_rate_control start

rc_update start
# qshell rc_update start

# land_detector start multicopter
qshell land_detector start multicopter

sleep 1

qshell modalai_esc start

qshell mixer load /dev/uart_esc quad_x.main.mix

sleep 1

# Magnetometer
qshell ist8310 start -X -b 1

# Barometer
qshell baro_thin_client start

# RC is on the apps side for now (Mavlink joystick from QGC)
# qshell rc driver

# IMU (accelerometer / gyroscope)
qshell imu_thin_client start

mavlink boot_complete
